// Service Worker for Web Push Notifications

// Push 이벤트 수신 처리
self.addEventListener("push", function(event) {
  if (!event.data) {
    console.log("Push event but no data");
    return;
  }

  let data;
  try {
    data = event.data.json();
  } catch (e) {
    data = {
      title: "알림",
      body: event.data.text()
    };
  }

  const options = {
    body: data.body || "",
    icon: data.icon || "/icon.png",
    badge: "/icon.png",
    vibrate: [100, 50, 100],
    data: {
      url: data.url || "/"
    },
    actions: [
      { action: "open", title: "열기" },
      { action: "close", title: "닫기" }
    ]
  };

  event.waitUntil(
    self.registration.showNotification(data.title || "Console", options)
  );
});

// 알림 클릭 처리
self.addEventListener("notificationclick", function(event) {
  event.notification.close();

  if (event.action === "close") {
    return;
  }

  const url = event.notification.data.url || "/";

  event.waitUntil(
    clients.matchAll({ type: "window", includeUncontrolled: true })
      .then(function(clientList) {
        // 이미 열린 창이 있으면 포커스
        for (let client of clientList) {
          if (client.url.includes(self.location.origin) && "focus" in client) {
            client.navigate(url);
            return client.focus();
          }
        }
        // 없으면 새 창 열기
        if (clients.openWindow) {
          return clients.openWindow(url);
        }
      })
  );
});

// ArrayBuffer를 Base64로 변환 (루프 기반으로 스택 오버플로우 방지)
function arrayBufferToBase64(buffer) {
  let binary = "";
  const bytes = new Uint8Array(buffer);
  for (let i = 0; i < bytes.byteLength; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}

// 구독 변경 처리
self.addEventListener("pushsubscriptionchange", function(event) {
  event.waitUntil(
    self.registration.pushManager.subscribe(event.oldSubscription.options)
      .then(function(subscription) {
        // 서버에 새 구독 정보 전송
        return fetch("/mypage/push_subscriptions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            push_subscription: {
              endpoint: subscription.endpoint,
              p256dh_key: arrayBufferToBase64(subscription.getKey("p256dh")),
              auth_key: arrayBufferToBase64(subscription.getKey("auth"))
            }
          })
        });
      })
  );
});
