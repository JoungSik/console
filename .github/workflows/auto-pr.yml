name: Create PR with Commit List

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main    # main ë¸Œëœì¹˜ë¡œì˜ PR ìƒì„± ë° ì»¤ë°‹ ì¶”ê°€ ì‹œ ì‹¤í–‰

jobs:
  update-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì™€ì„œ ì»¤ë°‹ ë¹„êµ ê°€ëŠ¥

      - name: Get commit list and PR info
        id: pr-info
        run: |
          # ê¸°ë³¸ ë¸Œëœì¹˜ (main)ì™€ ë¹„êµí•˜ì—¬ ì»¤ë°‹ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          BASE_BRANCH="main"
          CURRENT_BRANCH="${{ github.head_ref }}"

          # ì›ê²© ë¸Œëœì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          git fetch origin ${BASE_BRANCH}:${BASE_BRANCH} || git fetch origin ${BASE_BRANCH}

          # ë¸Œëœì¹˜ ì´ë¦„ì—ì„œ PR ì œëª© ìƒì„±
          PR_TITLE="feat: ${CURRENT_BRANCH}"

          # ì»¤ë°‹ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (main ë¸Œëœì¹˜ì™€ ì°¨ì´ì )
          echo "# ğŸ“ ë³€ê²½ì‚¬í•­" > pr_body.md
          echo "" >> pr_body.md
          echo "## ğŸ”„ í¬í•¨ëœ ì»¤ë°‹" >> pr_body.md
          echo "" >> pr_body.md

          # ì»¤ë°‹ ëª©ë¡ì„ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ìƒì„±
          if git rev-list --count origin/${BASE_BRANCH}..HEAD > /dev/null 2>&1; then
            git log origin/${BASE_BRANCH}..HEAD --pretty=format:"- %s (%an, %cr)" --reverse >> pr_body.md
            COMMIT_COUNT=$(git rev-list --count origin/${BASE_BRANCH}..HEAD)
          else
            echo "- ì»¤ë°‹ ë¹„êµë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì²« ë²ˆì§¸ ì»¤ë°‹ì´ê±°ë‚˜ ë¸Œëœì¹˜ ì •ë³´ê°€ ì—†ìŒ)" >> pr_body.md
            COMMIT_COUNT=0
          fi
          echo "" >> pr_body.md
          echo "" >> pr_body.md

          # ìš”ì•½
          echo "## ğŸ“Š ìš”ì•½" >> pr_body.md
          echo "- ì´ ${COMMIT_COUNT}ê°œì˜ ì»¤ë°‹" >> pr_body.md
          echo "- ê¸°ë³¸ ë¸Œëœì¹˜: \`${BASE_BRANCH}\`" >> pr_body.md
          echo "- ì‘ì—… ë¸Œëœì¹˜: \`${CURRENT_BRANCH}\`" >> pr_body.md
          echo "" >> pr_body.md

          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
          echo "## ğŸ“ ë³€ê²½ëœ íŒŒì¼" >> pr_body.md
          echo "" >> pr_body.md
          if git diff --name-only origin/${BASE_BRANCH}..HEAD > /dev/null 2>&1; then
            git diff --name-only origin/${BASE_BRANCH}..HEAD | sed 's/^/- /' >> pr_body.md
          else
            echo "- íŒŒì¼ ì°¨ì´ì ì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> pr_body.md
          fi
          echo "" >> pr_body.md

          # ìë™ ìƒì„± í‘œì‹œ
          echo "---" >> pr_body.md
          echo "ğŸ¤– ì´ PRì€ GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤." >> pr_body.md

          # GitHub Outputìœ¼ë¡œ ì„¤ì •
          echo "pr-title=${PR_TITLE}" >> $GITHUB_OUTPUT
          echo "base-branch=${BASE_BRANCH}" >> $GITHUB_OUTPUT
          echo "commit-count=${COMMIT_COUNT}" >> $GITHUB_OUTPUT

      - name: Update PR body
        run: |
          gh pr edit ${{ github.event.number }} --body-file pr_body.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR update
        run: |
          echo "âœ… PR ë³¸ë¬¸ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“Š ì´ ${{ steps.pr-info.outputs.commit-count }}ê°œì˜ ì»¤ë°‹ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤."